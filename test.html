<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iPhone AI Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #007aff; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; color: white; font-family: -apple-system;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .app-container {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom);
        }
        #preview-box {
            width: 100%; max-width: 320px; aspect-ratio: 1/1;
            background: #1c1c1e; border-radius: 30px; overflow: hidden;
            border: 2px solid #3a3a3c; position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .emoji-view { font-size: 90px; margin: 20px 0; min-height: 110px; transition: transform 0.1s; }
        .btn {
            background: var(--accent); color: white; border: none;
            padding: 20px 50px; border-radius: 18px; font-weight: 700;
            font-size: 20px; -webkit-appearance: none;
        }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .debug-log { font-size: 11px; color: #636366; margin-top: 20px; text-align: center; max-width: 80%; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="preview-box">
        <video id="webcam" autoplay muted playsinline webkit-playsinline></video>
    </div>
    
    <div class="emoji-view" id="emoji-display">üì∏</div>
    <div id="label" style="font-weight: 600; margin-bottom: 30px;">TAP TO BEGIN</div>
    
    <button class="btn" id="main-btn">ENABLE CAMERA</button>
    <p class="debug-log" id="status">Checking browser compatibility...</p>
</div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById("webcam");
    const emojiDisplay = document.getElementById("emoji-display");
    const label = document.getElementById("label");
    const status = document.getElementById("status");
    const mainBtn = document.getElementById("main-btn");

    let faceLandmarker;

    // DIAGNOSTIC CHECK
    window.onload = () => {
        if (!window.isSecureContext) {
            status.innerHTML = "‚ùå ERROR: Camera requires HTTPS.<br>You cannot run this from a local file.";
            mainBtn.style.background = "#3a3a3c";
        } else {
            status.innerText = "Secure Context Verified. Initializing AI...";
            loadAI();
        }
    };

    async function loadAI() {
        try {
            const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(fileset, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO"
            });
            status.innerText = "AI Engine Loaded.";
        } catch (e) {
            status.innerText = "AI Load Failed: " + e.message;
        }
    }

    mainBtn.addEventListener("click", async () => {
        if (!faceLandmarker) {
            alert("AI is still loading. Please wait 5 seconds.");
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: 480, height: 480 } 
            });
            
            video.srcObject = stream;
            
            // Force play for iOS
            video.onloadedmetadata = () => {
                video.play();
                mainBtn.style.display = "none";
                status.innerText = "Tracking Active";
                requestAnimationFrame(processFrame);
            };
        } catch (err) {
            alert("CAMERA BLOCKED: Go to iPhone Settings > Safari > Camera and set to 'Allow'.");
            status.innerText = "Error: " + err.name;
        }
    });

    function processFrame() {
        if (video.paused || video.ended) return;
        
        const results = faceLandmarker.detectForVideo(video, performance.now());
        
        if (results.faceBlendshapes?.[0]) {
            const s = results.faceBlendshapes[0].categories;
            const getScore = (name) => s.find(x => x.categoryName === name)?.score || 0;
            
            const smile = (getScore("mouthSmileLeft") + getScore("mouthSmileRight")) / 2;
            const open = getScore("jawOpen");

            if (open > 0.4) { update("üò≤", "WOW!"); }
            else if (smile > 0.4) { update("üòä", "HAPPY"); }
            else { update("üòê", "NEUTRAL"); }
        }
        requestAnimationFrame(processFrame);
    }

    function update(e, l) {
        if (emojiDisplay.innerText !== e) {
            emojiDisplay.innerText = e;
            label.innerText = l;
            emojiDisplay.style.transform = "scale(1.2)";
            setTimeout(() => emojiDisplay.style.transform = "scale(1)", 100);
        }
    }
</script>
</body>
</html>

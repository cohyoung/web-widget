<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FileMaker-like Web Widget (Single HTML)</title>

    <!-- React (no build step) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root {
        --bg: #f4f4f5;
        --card: #ffffff;
        --text: #18181b;
        --muted: #71717a;
        --border: #e4e4e7;
        --soft: #fafafa;
        --brand: #18181b;
        --brand2: #27272a;
        --danger: #dc2626;
        --shadow: 0 10px 30px rgba(0,0,0,0.08);
        --r: 16px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        color: var(--text);
        background: var(--bg);
      }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
      .row { display: flex; gap: 16px; }
      .col { display: flex; flex-direction: column; gap: 16px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--r);
        box-shadow: none;
      }
      .card.pad { padding: 12px; }
      .header {
        display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;
        flex-wrap: wrap;
      }
      h1 { margin: 0; font-size: 20px; font-weight: 700; }
      .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }
      .btn, .btn-ghost, .tab {
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid transparent;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        line-height: 1;
        user-select: none;
      }
      .btn { background: var(--brand); color: white; border-color: var(--brand); }
      .btn:hover { background: var(--brand2); border-color: var(--brand2); }
      .btn:disabled, .btn-ghost:disabled, .tab:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn-ghost { background: white; color: var(--text); border-color: var(--border); }
      .btn-ghost:hover { background: var(--soft); }
      .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
      .tab { background: white; border-color: var(--border); color: #3f3f46; }
      .tab.active { background: var(--brand); border-color: var(--brand); color: white; }

      .input, select, textarea {
        width: 100%;
        border: 1px solid var(--border);
        background: white;
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
      }
      .input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(24,24,27,0.12); border-color: #d4d4d8; }
      textarea { min-height: 140px; resize: vertical; }
      .muted { color: var(--muted); }
      .section-title { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
      .section-title .t { font-weight: 700; font-size: 13px; color: #27272a; }
      .divider { height: 1px; background: var(--border); margin: 12px 0; }
      .badge {
        display: inline-flex; align-items: center;
        padding: 2px 8px; border-radius: 999px;
        border: 1px solid var(--border);
        background: #fafafa;
        font-size: 12px;
        color: #3f3f46;
        gap: 6px;
      }
      .list { display: flex; flex-direction: column; gap: 6px; }
      .tableItem {
        display: flex; gap: 10px; align-items: center;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid transparent;
        background: transparent;
      }
      .tableItem:hover { background: var(--soft); border-color: var(--border); }
      .tableItem.active { background: #fafafa; border-color: var(--brand); }
      .tableItem .meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
      .icon {
        width: 26px; height: 26px; border-radius: 10px;
        border: 1px solid var(--border);
        background: #fafafa;
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 12px;
      }
      .trash {
        border: none; background: transparent; cursor: pointer;
        color: var(--muted); font-size: 14px;
      }
      .trash:hover { color: var(--text); }

      /* Grid / table */
      .gridWrap { overflow: auto; border-radius: var(--r); border: 1px solid var(--border); background: white; }
      table { border-collapse: collapse; width: 100%; font-size: 14px; }
      thead th {
        position: sticky; top: 0;
        background: #fafafa;
        border-bottom: 1px solid var(--border);
        text-align: left;
        padding: 10px 12px;
        font-weight: 800;
        color: #27272a;
        white-space: nowrap;
      }
      tbody td {
        border-bottom: 1px solid #f1f1f3;
        padding: 10px 12px;
        vertical-align: top;
      }
      tr:hover td { background: #fafafa; }
      tr.active td { background: #fafafa; }

      /* Modal */
      .modalOverlay {
        position: fixed; inset: 0; z-index: 9999;
        background: rgba(0,0,0,0.40);
        display: flex; align-items: center; justify-content: center;
        padding: 18px;
      }
      .modal {
        width: min(720px, 96vw);
        background: white;
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .modalHead {
        display: flex; align-items: center; justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid #f1f1f3;
        font-weight: 800;
      }
      .modalBody { padding: 14px; max-height: 70vh; overflow: auto; }
      .modalFoot { padding: 14px; border-top: 1px solid #f1f1f3; display: flex; justify-content: flex-end; gap: 10px; }

      /* Layout canvas */
      .canvasCard { overflow: hidden; }
      .canvasHead {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f1f3;
        display: flex; justify-content: space-between; gap: 10px; align-items: center;
        flex-wrap: wrap;
      }
      .canvasArea {
        position: relative;
        background: white;
      }
      .gridBg {
        position: absolute; inset: 0;
        opacity: 0.35;
        pointer-events: none;
        background-image:
          linear-gradient(to right, rgba(0,0,0,0.08) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0,0,0,0.08) 1px, transparent 1px);
      }
      .layoutItem {
        position: absolute;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      }
      .layoutItem.selected {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(24,24,27,0.10), 0 4px 12px rgba(0,0,0,0.06);
      }
      .layoutItemHead {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 10px 0 10px;
        font-size: 12px;
        color: #52525b;
      }
      .layoutItemHead .name { font-weight: 800; color: #27272a; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .layoutItemBody { padding: 8px 10px 10px; }
      .fakeControl { height: 32px; border-radius: 10px; border: 1px solid var(--border); background: #fafafa; }

      .helpFloat {
        position: fixed; right: 16px; bottom: 16px; z-index: 9000;
        width: min(340px, calc(100vw - 32px));
        border: 1px solid var(--border);
        background: white;
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 12px;
      }

      /* Responsive layout */
      @media (max-width: 980px) {
        .row { flex-direction: column; }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const LS_KEY = "fm_like_widget_single_html_v1";

      const FIELD_TYPES = [
        { id: "text", label: "Text" },
        { id: "number", label: "Number" },
        { id: "date", label: "Date" },
        { id: "boolean", label: "Boolean" },
        { id: "select", label: "Select" },
      ];

      function uid(prefix = "id") {
        return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
      }
      function deepClone(x) { return JSON.parse(JSON.stringify(x)); }
      function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
      function snap(n, grid) { if (!grid) return n; return Math.round(n / grid) * grid; }

      function defaultDB() {
        const tableId = uid("tbl");
        const nameFieldId = uid("fld");
        const createdFieldId = uid("fld");
        const layoutId = uid("lyt");
        return {
          version: 1,
          tables: {
            [tableId]: {
              id: tableId,
              name: "Contacts",
              fields: {
                [nameFieldId]: { id: nameFieldId, name: "Name", type: "text", required: true, options: [] },
                [createdFieldId]: { id: createdFieldId, name: "Created", type: "date", required: false, options: [] },
              },
              fieldOrder: [nameFieldId, createdFieldId],
              records: {},
              recordOrder: [],
              layouts: {
                [layoutId]: {
                  id: layoutId,
                  name: "Default Layout",
                  canvas: { width: 720, height: 460, grid: 10 },
                  items: [
                    { id: uid("itm"), fieldId: nameFieldId, x: 40, y: 40, w: 280, h: 56, label: "Name" },
                    { id: uid("itm"), fieldId: createdFieldId, x: 40, y: 120, w: 280, h: 56, label: "Created" },
                  ],
                },
              },
              layoutOrder: [layoutId],
            },
          },
          tableOrder: [tableId],
        };
      }

      function loadDB() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return defaultDB();
          const parsed = JSON.parse(raw);
          if (!parsed?.tables || !parsed?.tableOrder) return defaultDB();
          return parsed;
        } catch {
          return defaultDB();
        }
      }

      function saveDB(db) {
        try { localStorage.setItem(LS_KEY, JSON.stringify(db)); } catch {}
      }

      function FieldIcon({ type }) {
        const map = { text: "T", number: "#", date: "ðŸ“…", boolean: "âœ“", select: "â–¾" };
        return <span className="icon" title={type}>{map[type] ?? "?"}</span>;
      }

      function normalizeValue(type, value) {
        if (value == null) return value;
        if (type === "number") {
          const n = typeof value === "number" ? value : Number(value);
          return Number.isFinite(n) ? n : "";
        }
        if (type === "boolean") return !!value;
        if (type === "date") {
          if (value instanceof Date) return value.toISOString().slice(0,10);
          if (typeof value === "string") return value.slice(0,10);
          return "";
        }
        return value;
      }

      function formatValue(type, value) {
        if (value == null) return "";
        if (type === "boolean") return value ? "True" : "False";
        return String(value);
      }

      function coerceRecordForFields(record, fieldsById) {
        const out = { ...record };
        for (const fid of Object.keys(fieldsById)) {
          const f = fieldsById[fid];
          if (!(fid in out)) out[fid] = f.type === "boolean" ? false : "";
          out[fid] = normalizeValue(f.type, out[fid]);
        }
        return out;
      }

      function recordMatchesQuery(record, fields, query) {
        if (!query.trim()) return true;
        const q = query.trim().toLowerCase();
        return fields.some((f) => formatValue(f.type, record[f.id]).toLowerCase().includes(q));
      }

      function exportJSON(db) {
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "fm_like_widget_export.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result ?? ""));
          r.onerror = reject;
          r.readAsText(file);
        });
      }

      function Modal({ title, open, onClose, children, footer }) {
        if (!open) return null;
        return (
          <div className="modalOverlay" onMouseDown={(e) => { if (e.target.classList.contains("modalOverlay")) onClose(); }}>
            <div className="modal" onMouseDown={(e) => e.stopPropagation()}>
              <div className="modalHead">
                <div>{title}</div>
                <button className="trash" onClick={onClose} aria-label="Close">âœ•</button>
              </div>
              <div className="modalBody">{children}</div>
              {footer ? <div className="modalFoot">{footer}</div> : null}
            </div>
          </div>
        );
      }

      function SectionTitle({ title, right }) {
        return (
          <div className="section-title">
            <div className="t">{title}</div>
            {right}
          </div>
        );
      }

      function EmptyState({ title, desc, action }) {
        return (
          <div className="card pad" style={{ borderStyle: "dashed", textAlign: "center", padding: 20 }}>
            <div style={{ fontWeight: 800 }}>{title}</div>
            <div className="muted" style={{ marginTop: 6, fontSize: 13 }}>{desc}</div>
            {action ? <div style={{ marginTop: 14, display: "inline-flex" }}>{action}</div> : null}
          </div>
        );
      }

      function RecordEditor({ table, record, onChange }) {
        const fields = table.fieldOrder.map((id) => table.fields[id]).filter(Boolean);
        return (
          <div className="col" style={{ gap: 10 }}>
            {fields.map((f) => {
              const v = record[f.id];
              return (
                <div key={f.id} style={{ display: "grid", gridTemplateColumns: "1fr 1.6fr", gap: 12, alignItems: "center" }}>
                  <div>
                    <div style={{ fontWeight: 800, fontSize: 13 }}>{f.name}</div>
                    <div className="muted" style={{ fontSize: 12 }}>{f.type}{f.required ? " Â· required" : ""}</div>
                  </div>
                  <div>
                    {f.type === "text" ? (
                      <input className="input" value={v ?? ""} onChange={(e) => onChange({ ...record, [f.id]: e.target.value })} />
                    ) : f.type === "number" ? (
                      <input className="input" type="number" value={v ?? ""} onChange={(e) => onChange({ ...record, [f.id]: normalizeValue("number", e.target.value) })} />
                    ) : f.type === "date" ? (
                      <input className="input" type="date" value={(v ?? "").slice(0,10)} onChange={(e) => onChange({ ...record, [f.id]: normalizeValue("date", e.target.value) })} />
                    ) : f.type === "boolean" ? (
                      <label style={{ display: "inline-flex", alignItems: "center", gap: 10 }}>
                        <input type="checkbox" checked={!!v} onChange={(e) => onChange({ ...record, [f.id]: e.target.checked })} />
                        <span className="muted" style={{ fontSize: 13 }}>{v ? "True" : "False"}</span>
                      </label>
                    ) : f.type === "select" ? (
                      <select value={v ?? ""} onChange={(e) => onChange({ ...record, [f.id]: e.target.value })}>
                        <option value="">â€”</option>
                        {(f.options ?? []).map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                    ) : (
                      <input className="input" value={v ?? ""} onChange={(e) => onChange({ ...record, [f.id]: e.target.value })} />
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function DataGrid({ table, searchQuery, onSelectRecordId, selectedRecordId }) {
        const fields = table.fieldOrder.map((id) => table.fields[id]).filter(Boolean);
        const records = table.recordOrder.map((rid) => table.records[rid]).filter(Boolean);

        const filtered = useMemo(() => records.filter((r) => recordMatchesQuery(r.data, fields, searchQuery)), [records, fields, searchQuery]);

        if (!fields.length) {
          return <EmptyState title="No fields yet" desc="Add fields in Schema to start capturing data." />;
        }

        return (
          <div className="gridWrap">
            <table>
              <thead>
                <tr>
                  {fields.map((f) => (
                    <th key={f.id}>
                      <span style={{ display: "inline-flex", alignItems: "center", gap: 8 }}>
                        <FieldIcon type={f.type} />
                        {f.name}
                      </span>
                    </th>
                  ))}
                  <th style={{ width: 110 }}></th>
                </tr>
              </thead>
              <tbody>
                {filtered.length === 0 ? (
                  <tr><td colSpan={fields.length + 1} className="muted" style={{ padding: 16 }}>No records match your search.</td></tr>
                ) : (
                  filtered.map((r) => {
                    const active = r.id === selectedRecordId;
                    return (
                      <tr key={r.id} className={active ? "active" : ""}>
                        {fields.map((f) => <td key={f.id}>{formatValue(f.type, r.data[f.id])}</td>)}
                        <td>
                          <button className="btn-ghost" style={{ padding: "8px 10px", borderRadius: 12 }} onClick={() => onSelectRecordId(r.id)}>
                            Edit
                          </button>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        );
      }

      function LayoutCanvas({
        table,
        layout,
        mode,
        selectedItemId,
        onSelectItem,
        onUpdateLayout,
        paletteFieldId,
        onClearPalette,
      }) {
        const ref = useRef(null);
        const dragRef = useRef(null);
        const fieldsById = table.fields;

        function getCanvasPoint(e) {
          const rect = ref.current?.getBoundingClientRect();
          if (!rect) return { x: 0, y: 0 };
          return { x: clamp(e.clientX - rect.left, 0, rect.width), y: clamp(e.clientY - rect.top, 0, rect.height) };
        }

        function handlePointerDown(e) {
          if (mode !== "edit") return;
          const pt = getCanvasPoint(e);

          const hit = [...(layout.items ?? [])].reverse().find((it) =>
            pt.x >= it.x && pt.x <= it.x + it.w && pt.y >= it.y && pt.y <= it.y + it.h
          );

          if (!hit && paletteFieldId) {
            const f = fieldsById[paletteFieldId];
            if (!f) return;
            const grid = layout.canvas.grid ?? 10;
            const nx = snap(pt.x, grid);
            const ny = snap(pt.y, grid);
            const newItem = {
              id: uid("itm"),
              fieldId: paletteFieldId,
              x: clamp(nx, 0, layout.canvas.width - 240),
              y: clamp(ny, 0, layout.canvas.height - 56),
              w: 280,
              h: 56,
              label: f.name,
            };
            onUpdateLayout({ ...layout, items: [...(layout.items ?? []), newItem] });
            onSelectItem(newItem.id);
            onClearPalette?.();
            return;
          }

          if (!hit) { onSelectItem(null); return; }
          onSelectItem(hit.id);

          dragRef.current = {
            itemId: hit.id,
            startX: pt.x,
            startY: pt.y,
            origX: hit.x,
            origY: hit.y,
          };
          e.currentTarget.setPointerCapture?.(e.pointerId);
        }

        function handlePointerMove(e) {
          if (mode !== "edit") return;
          const drag = dragRef.current;
          if (!drag) return;

          const pt = getCanvasPoint(e);
          const dx = pt.x - drag.startX;
          const dy = pt.y - drag.startY;

          const grid = layout.canvas.grid ?? 10;
          const nextItems = (layout.items ?? []).map((it) => {
            if (it.id !== drag.itemId) return it;
            const nx = snap(drag.origX + dx, grid);
            const ny = snap(drag.origY + dy, grid);
            return {
              ...it,
              x: clamp(nx, 0, layout.canvas.width - it.w),
              y: clamp(ny, 0, layout.canvas.height - it.h),
            };
          });
          onUpdateLayout({ ...layout, items: nextItems });
        }

        function handlePointerUp(e) {
          if (mode !== "edit") return;
          dragRef.current = null;
          e.currentTarget.releasePointerCapture?.(e.pointerId);
        }

        const grid = layout.canvas.grid ?? 0;

        return (
          <div className="card canvasCard">
            <div className="canvasHead">
              <div style={{ fontSize: 13 }}>
                <b>Canvas</b>
                <span className="muted"> Â· {layout.canvas.width}Ã—{layout.canvas.height}px</span>
                <span className="muted"> Â· grid {grid}</span>
              </div>
              {mode === "edit" ? <div className="muted" style={{ fontSize: 12 }}>Tip: select a field in the palette, then click the canvas to place it.</div> : null}
            </div>

            <div
              ref={ref}
              className="canvasArea"
              style={{ width: layout.canvas.width, height: layout.canvas.height }}
              onPointerDown={handlePointerDown}
              onPointerMove={handlePointerMove}
              onPointerUp={handlePointerUp}
            >
              {grid ? (
                <div className="gridBg" style={{ backgroundSize: `${grid}px ${grid}px` }} />
              ) : null}

              {(layout.items ?? []).map((it) => {
                const f = fieldsById[it.fieldId];
                const selected = it.id === selectedItemId;
                return (
                  <div
                    key={it.id}
                    className={"layoutItem" + (selected ? " selected" : "")}
                    style={{ left: it.x, top: it.y, width: it.w, height: it.h, cursor: mode === "edit" ? "move" : "default" }}
                    onPointerDown={(e) => {
                      e.stopPropagation();
                      if (mode !== "edit") return;
                      onSelectItem(it.id);

                      const rect = ref.current?.getBoundingClientRect();
                      if (!rect) return;
                      const pt = { x: clamp(e.clientX - rect.left, 0, rect.width), y: clamp(e.clientY - rect.top, 0, rect.height) };
                      dragRef.current = { itemId: it.id, startX: pt.x, startY: pt.y, origX: it.x, origY: it.y };
                      e.currentTarget.setPointerCapture?.(e.pointerId);
                    }}
                    onPointerUp={(e) => {
                      if (mode !== "edit") return;
                      dragRef.current = null;
                      e.currentTarget.releasePointerCapture?.(e.pointerId);
                    }}
                  >
                    <div className="layoutItemHead">
                      <FieldIcon type={f?.type} />
                      <span className="name" style={{ flex: 1 }}>{it.label || f?.name || "Field"}</span>
                      <span className="muted" style={{ fontSize: 11 }}>{f?.type ?? ""}</span>
                    </div>
                    <div className="layoutItemBody">
                      <div className="fakeControl"></div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function FileMakerLikeWidget() {
        const [db, setDB] = useState(() => loadDB());
        const [activeTableId, setActiveTableId] = useState(() => loadDB().tableOrder?.[0] ?? null);
        const [activeTab, setActiveTab] = useState("data"); // data | schema | layouts
        const [searchQuery, setSearchQuery] = useState("");

        const [isNewTableOpen, setIsNewTableOpen] = useState(false);
        const [newTableName, setNewTableName] = useState("");

        const [isFieldModalOpen, setIsFieldModalOpen] = useState(false);
        const [fieldDraft, setFieldDraft] = useState({ name: "", type: "text", required: false, optionsText: "" });

        const [selectedRecordId, setSelectedRecordId] = useState(null);
        const [recordDraft, setRecordDraft] = useState(null);

        const [selectedLayoutId, setSelectedLayoutId] = useState(null);
        const [layoutMode, setLayoutMode] = useState("edit"); // edit | preview
        const [selectedLayoutItemId, setSelectedLayoutItemId] = useState(null);
        const [paletteFieldId, setPaletteFieldId] = useState(null);

        const [isImportOpen, setIsImportOpen] = useState(false);
        const [importErr, setImportErr] = useState("");

        const table = activeTableId ? db.tables[activeTableId] : null;

        useEffect(() => { saveDB(db); }, [db]);

        useEffect(() => {
          if (!activeTableId && db.tableOrder.length) setActiveTableId(db.tableOrder[0]);
          if (activeTableId && !db.tables[activeTableId]) setActiveTableId(db.tableOrder[0] ?? null);
        }, [db, activeTableId]);

        useEffect(() => {
          if (!table) return;
          const first = table.layoutOrder?.[0] ?? null;
          if (!selectedLayoutId) setSelectedLayoutId(first);
          if (selectedLayoutId && !table.layouts[selectedLayoutId]) setSelectedLayoutId(first);
        }, [table, selectedLayoutId]);

        const layouts = table ? table.layoutOrder.map((id) => table.layouts[id]).filter(Boolean) : [];
        const activeLayout = table && selectedLayoutId ? table.layouts[selectedLayoutId] : null;

        const fields = table ? table.fieldOrder.map((id) => table.fields[id]).filter(Boolean) : [];

        function updateTable(nextTable) {
          setDB((prev) => ({ ...prev, tables: { ...prev.tables, [nextTable.id]: nextTable } }));
        }

        function createTable() {
          const name = newTableName.trim() || "Untitled";
          const tableId = uid("tbl");
          const layoutId = uid("lyt");
          const next = {
            id: tableId,
            name,
            fields: {},
            fieldOrder: [],
            records: {},
            recordOrder: [],
            layouts: {
              [layoutId]: { id: layoutId, name: "Default Layout", canvas: { width: 720, height: 460, grid: 10 }, items: [] },
            },
            layoutOrder: [layoutId],
          };
          setDB((prev) => ({
            ...prev,
            tables: { ...prev.tables, [tableId]: next },
            tableOrder: [...prev.tableOrder, tableId],
          }));
          setActiveTableId(tableId);
          setActiveTab("schema");
          setNewTableName("");
          setIsNewTableOpen(false);
        }

        function deleteTable(tableId) {
          setDB((prev) => {
            const next = deepClone(prev);
            delete next.tables[tableId];
            next.tableOrder = next.tableOrder.filter((id) => id !== tableId);
            return next;
          });
          if (activeTableId === tableId) setActiveTableId(null);
        }

        function openNewFieldModal() {
          setFieldDraft({ name: "", type: "text", required: false, optionsText: "" });
          setIsFieldModalOpen(true);
        }

        function addField() {
          if (!table) return;
          const name = fieldDraft.name.trim();
          if (!name) return;

          const fieldId = uid("fld");
          const options = fieldDraft.type === "select"
            ? fieldDraft.optionsText.split("\n").map(s => s.trim()).filter(Boolean)
            : [];

          const newField = { id: fieldId, name, type: fieldDraft.type, required: !!fieldDraft.required, options };

          const nextTable = deepClone(table);
          nextTable.fields[fieldId] = newField;
          nextTable.fieldOrder.push(fieldId);

          for (const rid of nextTable.recordOrder) {
            const rec = nextTable.records[rid];
            if (!rec) continue;
            if (!(fieldId in rec.data)) rec.data[fieldId] = newField.type === "boolean" ? false : "";
          }

          updateTable(nextTable);
          setIsFieldModalOpen(false);
        }

        function deleteField(fieldId) {
          if (!table) return;
          const nextTable = deepClone(table);
          delete nextTable.fields[fieldId];
          nextTable.fieldOrder = nextTable.fieldOrder.filter((id) => id !== fieldId);

          for (const rid of nextTable.recordOrder) {
            const rec = nextTable.records[rid];
            if (!rec) continue;
            delete rec.data[fieldId];
          }

          for (const lid of nextTable.layoutOrder) {
            const l = nextTable.layouts[lid];
            if (!l) continue;
            l.items = (l.items ?? []).filter((it) => it.fieldId !== fieldId);
          }

          updateTable(nextTable);
        }

        function createRecord() {
          if (!table) return;
          const nextTable = deepClone(table);
          const rid = uid("rec");
          const data = coerceRecordForFields({}, nextTable.fields);

          for (const fid of nextTable.fieldOrder) {
            const f = nextTable.fields[fid];
            if (f?.type === "date" && !data[fid]) data[fid] = new Date().toISOString().slice(0,10);
          }

          nextTable.records[rid] = { id: rid, data };
          nextTable.recordOrder.unshift(rid);
          updateTable(nextTable);

          setSelectedRecordId(rid);
          setRecordDraft(deepClone(data));
        }

        function openEditRecord(rid) {
          if (!table) return;
          const rec = table.records[rid];
          if (!rec) return;
          setSelectedRecordId(rid);
          setRecordDraft(deepClone(coerceRecordForFields(rec.data, table.fields)));
        }

        function saveRecord() {
          if (!table || !selectedRecordId) return;
          const nextTable = deepClone(table);
          const rec = nextTable.records[selectedRecordId];
          if (!rec) return;

          for (const fid of nextTable.fieldOrder) {
            const f = nextTable.fields[fid];
            if (!f?.required) continue;
            const val = recordDraft?.[fid];
            const empty = f.type === "boolean" ? false : !String(val ?? "").trim();
            if (empty) { alert(`Required field missing: ${f.name}`); return; }
          }

          rec.data = coerceRecordForFields(recordDraft ?? {}, nextTable.fields);
          updateTable(nextTable);
        }

        function deleteRecord(rid) {
          if (!table) return;
          const nextTable = deepClone(table);
          delete nextTable.records[rid];
          nextTable.recordOrder = nextTable.recordOrder.filter((id) => id !== rid);
          updateTable(nextTable);
          if (selectedRecordId === rid) {
            setSelectedRecordId(null);
            setRecordDraft(null);
          }
        }

        function createLayout() {
          if (!table) return;
          const nextTable = deepClone(table);
          const lid = uid("lyt");
          nextTable.layouts[lid] = { id: lid, name: `Layout ${nextTable.layoutOrder.length + 1}`, canvas: { width: 720, height: 460, grid: 10 }, items: [] };
          nextTable.layoutOrder.push(lid);
          updateTable(nextTable);
          setSelectedLayoutId(lid);
          setSelectedLayoutItemId(null);
          setPaletteFieldId(null);
        }

        function updateLayout(nextLayout) {
          if (!table) return;
          const nextTable = deepClone(table);
          nextTable.layouts[nextLayout.id] = nextLayout;
          updateTable(nextTable);
        }

        function deleteLayout(layoutId) {
          if (!table) return;
          const nextTable = deepClone(table);
          delete nextTable.layouts[layoutId];
          nextTable.layoutOrder = nextTable.layoutOrder.filter((id) => id !== layoutId);
          updateTable(nextTable);
          setSelectedLayoutId(nextTable.layoutOrder[0] ?? null);
        }

        function deleteLayoutItem(itemId) {
          if (!activeLayout) return;
          const nextLayout = deepClone(activeLayout);
          nextLayout.items = (nextLayout.items ?? []).filter((it) => it.id !== itemId);
          updateLayout(nextLayout);
          setSelectedLayoutItemId(null);
        }

        function updateLayoutItem(itemId, patch) {
          if (!activeLayout) return;
          const nextLayout = deepClone(activeLayout);
          nextLayout.items = (nextLayout.items ?? []).map((it) => (it.id === itemId ? { ...it, ...patch } : it));
          updateLayout(nextLayout);
        }

        const selectedLayoutItem = useMemo(() => {
          if (!activeLayout || !selectedLayoutItemId) return null;
          return (activeLayout.items ?? []).find((it) => it.id === selectedLayoutItemId) ?? null;
        }, [activeLayout, selectedLayoutItemId]);

        async function handleImport(file) {
          setImportErr("");
          try {
            const txt = await readFileAsText(file);
            const parsed = JSON.parse(txt);
            if (!parsed?.tables || !parsed?.tableOrder) throw new Error("Invalid format");
            setDB(parsed);
            setActiveTableId(parsed.tableOrder?.[0] ?? null);
            setIsImportOpen(false);
          } catch (e) {
            setImportErr(String(e?.message ?? e));
          }
        }

        return (
          <div className="wrap">
            {/* Header */}
            <div className="header">
              <div>
                <h1>FileMaker-like Web Widget</h1>
                <div className="sub">Tables Â· Fields Â· Search Â· Layouts (drag & drop) Â· localStorage</div>
              </div>
              <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                <button className="btn-ghost" onClick={() => exportJSON(db)}>Export JSON</button>
                <button className="btn-ghost" onClick={() => setIsImportOpen(true)}>Import JSON</button>
                <button
                  className="btn-ghost"
                  onClick={() => {
                    if (!confirm("Reset all data?")) return;
                    const fresh = defaultDB();
                    setDB(fresh);
                    setActiveTableId(fresh.tableOrder[0] ?? null);
                    setActiveTab("data");
                    setSearchQuery("");
                    setSelectedRecordId(null);
                    setRecordDraft(null);
                    setSelectedLayoutId(null);
                    setSelectedLayoutItemId(null);
                    setPaletteFieldId(null);
                  }}
                >
                  Reset
                </button>
              </div>
            </div>

            <div className="row" style={{ marginTop: 16 }}>
              {/* Sidebar */}
              <div style={{ flex: "0 0 320px" }}>
                <div className="card pad">
                  <SectionTitle
                    title="Tables"
                    right={<button className="btn" style={{ padding: "8px 10px", borderRadius: 12 }} onClick={() => setIsNewTableOpen(true)}>+ New</button>}
                  />

                  <div className="list">
                    {db.tableOrder.map((tid) => {
                      const t = db.tables[tid];
                      if (!t) return null;
                      const active = tid === activeTableId;
                      return (
                        <div key={tid} className={"tableItem" + (active ? " active" : "")}>
                          <button
                            style={{ flex: 1, border: "none", background: "transparent", textAlign: "left", cursor: "pointer", padding: 0 }}
                            onClick={() => {
                              setActiveTableId(tid);
                              setActiveTab("data");
                              setSelectedRecordId(null);
                              setRecordDraft(null);
                              setSearchQuery("");
                              setPaletteFieldId(null);
                              setSelectedLayoutItemId(null);
                            }}
                          >
                            <div style={{ fontWeight: 800, fontSize: 14, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{t.name}</div>
                            <div className="meta">{t.fieldOrder.length} fields Â· {t.recordOrder.length} records</div>
                          </button>
                          <button
                            className="trash"
                            title="Delete table"
                            onClick={() => {
                              if (!confirm(`Delete table "${t.name}"? This cannot be undone.`)) return;
                              deleteTable(tid);
                            }}
                          >
                            ðŸ—‘
                          </button>
                        </div>
                      );
                    })}
                  </div>

                  <div className="divider"></div>

                  <div className="muted" style={{ fontSize: 12, lineHeight: 1.5 }}>
                    <b style={{ color: "#3f3f46" }}>MVP features</b>
                    <ul style={{ margin: "6px 0 0 18px", padding: 0 }}>
                      <li>Basic field types</li>
                      <li>Full-table search</li>
                      <li>Layouts: place fields on canvas</li>
                      <li>Export/Import + local persistence</li>
                    </ul>
                  </div>
                </div>
              </div>

              {/* Main */}
              <div style={{ flex: 1, minWidth: 0 }}>
                {!table ? (
                  <EmptyState
                    title="No table selected"
                    desc="Create a table to get started."
                    action={<button className="btn" onClick={() => setIsNewTableOpen(true)}>Create table</button>}
                  />
                ) : (
                  <div className="col">
                    <div className="card pad">
                      <div className="header" style={{ alignItems: "center" }}>
                        <div>
                          <div style={{ fontSize: 18, fontWeight: 800 }}>{table.name}</div>
                          <div className="muted" style={{ fontSize: 12 }}>
                            Active table Â· {table.fieldOrder.length} fields Â· {table.recordOrder.length} records
                          </div>
                        </div>
                        <div className="tabs">
                          <button className={"tab" + (activeTab === "data" ? " active" : "")} onClick={() => setActiveTab("data")}>Data</button>
                          <button className={"tab" + (activeTab === "schema" ? " active" : "")} onClick={() => setActiveTab("schema")}>Schema</button>
                          <button className={"tab" + (activeTab === "layouts" ? " active" : "")} onClick={() => setActiveTab("layouts")}>Layouts</button>
                        </div>
                      </div>
                    </div>

                    {/* Data */}
                    {activeTab === "data" ? (
                      <div className="row">
                        <div style={{ flex: 1, minWidth: 0 }} className="col">
                          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
                            <div style={{ flex: 1, minWidth: 260, display: "flex", gap: 8 }}>
                              <input className="input" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Search across all fieldsâ€¦" />
                              <button className="btn-ghost" onClick={() => setSearchQuery("")}>Clear</button>
                            </div>
                            <button className="btn" onClick={createRecord}>+ New Record</button>
                          </div>

                          <DataGrid
                            table={table}
                            searchQuery={searchQuery}
                            selectedRecordId={selectedRecordId}
                            onSelectRecordId={(rid) => openEditRecord(rid)}
                          />
                        </div>

                        <div style={{ flex: "0 0 360px" }} className="col">
                          <div className="card pad">
                            <SectionTitle
                              title={selectedRecordId ? "Record" : "No record selected"}
                              right={
                                selectedRecordId ? (
                                  <div style={{ display: "flex", gap: 8 }}>
                                    <button
                                      className="btn-ghost"
                                      onClick={() => {
                                        if (!confirm("Delete this record?")) return;
                                        deleteRecord(selectedRecordId);
                                      }}
                                    >
                                      Delete
                                    </button>
                                    <button className="btn" onClick={saveRecord} disabled={!recordDraft}>Save</button>
                                  </div>
                                ) : null
                              }
                            />

                            {selectedRecordId && recordDraft ? (
                              <RecordEditor table={table} record={recordDraft} onChange={setRecordDraft} />
                            ) : (
                              <div className="muted" style={{ fontSize: 13 }}>Select a record to edit, or create a new one.</div>
                            )}
                          </div>

                          <div className="card pad">
                            <SectionTitle title="Layout Preview" />
                            <div className="muted" style={{ fontSize: 13 }}>
                              Design forms in <b>Layouts</b>. Preview mode shows a form bound to the selected record.
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : null}

                    {/* Schema */}
                    {activeTab === "schema" ? (
                      <div className="row">
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div className="card pad">
                            <SectionTitle
                              title="Fields"
                              right={<button className="btn" style={{ padding: "8px 10px" }} onClick={openNewFieldModal}>+ Add Field</button>}
                            />

                            {fields.length === 0 ? (
                              <EmptyState
                                title="No fields"
                                desc="Add your first field to start building this table."
                                action={<button className="btn" onClick={openNewFieldModal}>Add field</button>}
                              />
                            ) : (
                              <div className="list" style={{ gap: 10 }}>
                                {fields.map((f) => (
                                  <div key={f.id} className="card" style={{ padding: 12, borderRadius: 16 }}>
                                    <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
                                      <FieldIcon type={f.type} />
                                      <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: 900 }}>{f.name}</div>
                                        <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 6 }}>
                                          <span className="badge">{f.type}</span>
                                          {f.required ? <span className="badge" style={{ background: "#fffbeb" }}>required</span> : null}
                                          {f.type === "select" && (f.options?.length ?? 0) > 0 ? <span className="muted" style={{ fontSize: 12 }}>{f.options.length} options</span> : null}
                                        </div>
                                      </div>
                                      <button
                                        className="btn-ghost"
                                        onClick={() => {
                                          if (!confirm(`Delete field "${f.name}"?`)) return;
                                          deleteField(f.id);
                                        }}
                                      >
                                        Delete
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        <div style={{ flex: "0 0 360px" }} className="col">
                          <div className="card pad">
                            <SectionTitle title="Tips" />
                            <div className="muted" style={{ fontSize: 13, lineHeight: 1.55 }}>
                              <p><b style={{ color: "#3f3f46" }}>Search</b> scans all fields as text.</p>
                              <p><b style={{ color: "#3f3f46" }}>Layouts</b> are per-table and store placed field controls.</p>
                              <p>This widget uses <span className="badge">localStorage</span>. Export/Import to back up.</p>
                              <div className="divider"></div>
                              <p style={{ fontSize: 12 }}>
                                Next upgrades: relationships, calculations, per-field finds, scripts, access control, server sync.
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : null}

                    {/* Layouts */}
                    {activeTab === "layouts" ? (
                      <div className="row">
                        <div style={{ flex: "0 0 360px" }} className="col">
                          <div className="card pad">
                            <SectionTitle
                              title="Layouts"
                              right={<button className="btn" style={{ padding: "8px 10px" }} onClick={createLayout}>+ New</button>}
                            />
                            <div className="list">
                              {layouts.map((l) => {
                                const active = l.id === selectedLayoutId;
                                return (
                                  <div key={l.id} className={"tableItem" + (active ? " active" : "")}>
                                    <button
                                      style={{ flex: 1, border: "none", background: "transparent", textAlign: "left", cursor: "pointer", padding: 0 }}
                                      onClick={() => {
                                        setSelectedLayoutId(l.id);
                                        setSelectedLayoutItemId(null);
                                        setPaletteFieldId(null);
                                      }}
                                    >
                                      <div style={{ fontWeight: 900, fontSize: 14, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{l.name}</div>
                                      <div className="meta">{(l.items ?? []).length} items</div>
                                    </button>
                                    <button
                                      className="trash"
                                      title="Delete layout"
                                      onClick={() => {
                                        if (!confirm(`Delete layout "${l.name}"?`)) return;
                                        deleteLayout(l.id);
                                      }}
                                    >
                                      ðŸ—‘
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          <div className="card pad">
                            <SectionTitle
                              title="Field Palette"
                              right={
                                <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                                  <button className="btn-ghost" disabled={!paletteFieldId} onClick={() => setPaletteFieldId(null)}>Clear</button>
                                  <button className="btn-ghost" onClick={() => setLayoutMode(m => (m === "edit" ? "preview" : "edit"))}>
                                    {layoutMode === "edit" ? "Preview" : "Edit"}
                                  </button>
                                </div>
                              }
                            />

                            {fields.length === 0 ? (
                              <div className="muted" style={{ fontSize: 13 }}>Add fields in Schema first.</div>
                            ) : (
                              <div className="list" style={{ gap: 10 }}>
                                {fields.map((f) => {
                                  const active = paletteFieldId === f.id;
                                  return (
                                    <button
                                      key={f.id}
                                      className={"tableItem" + (active ? " active" : "")}
                                      style={{ width: "100%", textAlign: "left", cursor: "pointer" }}
                                      onClick={() => { setPaletteFieldId(f.id); setLayoutMode("edit"); }}
                                    >
                                      <FieldIcon type={f.type} />
                                      <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: 900, fontSize: 13 }}>{f.name}</div>
                                        <div className="meta">{f.type}</div>
                                      </div>
                                      {active ? <span className="badge" style={{ background: "#ecfdf5" }}>Selected</span> : null}
                                    </button>
                                  );
                                })}
                              </div>
                            )}
                          </div>

                          <div className="card pad">
                            <SectionTitle title="Inspector" />
                            {!activeLayout ? (
                              <div className="muted" style={{ fontSize: 13 }}>No layout selected.</div>
                            ) : !selectedLayoutItem ? (
                              <div className="muted" style={{ fontSize: 13 }}>Select an item on the canvas to edit label/position.</div>
                            ) : (
                              <div className="col" style={{ gap: 10 }}>
                                <div>
                                  <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>Label</div>
                                  <input className="input" value={selectedLayoutItem.label ?? ""} onChange={(e) => updateLayoutItem(selectedLayoutItem.id, { label: e.target.value })} />
                                </div>

                                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                                  <div>
                                    <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>X</div>
                                    <input className="input" type="number" value={selectedLayoutItem.x}
                                      onChange={(e) => updateLayoutItem(selectedLayoutItem.id, { x: Number(e.target.value || 0) })} />
                                  </div>
                                  <div>
                                    <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>Y</div>
                                    <input className="input" type="number" value={selectedLayoutItem.y}
                                      onChange={(e) => updateLayoutItem(selectedLayoutItem.id, { y: Number(e.target.value || 0) })} />
                                  </div>
                                  <div>
                                    <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>W</div>
                                    <input className="input" type="number" value={selectedLayoutItem.w}
                                      onChange={(e) => updateLayoutItem(selectedLayoutItem.id, { w: Math.max(120, Number(e.target.value || 0)) })} />
                                  </div>
                                  <div>
                                    <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>H</div>
                                    <input className="input" type="number" value={selectedLayoutItem.h}
                                      onChange={(e) => updateLayoutItem(selectedLayoutItem.id, { h: Math.max(48, Number(e.target.value || 0)) })} />
                                  </div>
                                </div>

                                <div style={{ display: "flex", gap: 10 }}>
                                  <button className="btn-ghost" style={{ flex: 1 }}
                                    onClick={() => { if (!confirm("Remove this item from the layout?")) return; deleteLayoutItem(selectedLayoutItem.id); }}>
                                    Remove
                                  </button>
                                  <button className="btn" style={{ flex: 1 }}
                                    onClick={() => {
                                      const next = deepClone(activeLayout);
                                      const idx = next.items.findIndex((it) => it.id === selectedLayoutItem.id);
                                      if (idx >= 0) {
                                        const [it] = next.items.splice(idx, 1);
                                        next.items.push(it);
                                        updateLayout(next);
                                      }
                                    }}>
                                    Bring Front
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>

                          <div className="card pad">
                            <SectionTitle title="Canvas Settings" />
                            {!activeLayout ? null : (
                              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10 }}>
                                <div>
                                  <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>Width</div>
                                  <input className="input" type="number" value={activeLayout.canvas.width}
                                    onChange={(e) => updateLayout({ ...activeLayout, canvas: { ...activeLayout.canvas, width: Math.max(320, Number(e.target.value || 0)) } })} />
                                </div>
                                <div>
                                  <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>Height</div>
                                  <input className="input" type="number" value={activeLayout.canvas.height}
                                    onChange={(e) => updateLayout({ ...activeLayout, canvas: { ...activeLayout.canvas, height: Math.max(240, Number(e.target.value || 0)) } })} />
                                </div>
                                <div>
                                  <div className="muted" style={{ fontSize: 12, marginBottom: 6 }}>Grid</div>
                                  <input className="input" type="number" value={activeLayout.canvas.grid ?? 0}
                                    onChange={(e) => updateLayout({ ...activeLayout, canvas: { ...activeLayout.canvas, grid: Math.max(0, Number(e.target.value || 0)) } })} />
                                </div>
                              </div>
                            )}
                          </div>
                        </div>

                        <div style={{ flex: 1, minWidth: 0 }} className="col">
                          {!activeLayout ? (
                            <EmptyState title="No layout" desc="Create a layout to start designing." action={<button className="btn" onClick={createLayout}>Create layout</button>} />
                          ) : (
                            <>
                              <LayoutCanvas
                                table={table}
                                layout={activeLayout}
                                mode={layoutMode}
                                selectedItemId={selectedLayoutItemId}
                                onSelectItem={setSelectedLayoutItemId}
                                onUpdateLayout={updateLayout}
                                paletteFieldId={paletteFieldId}
                                onClearPalette={() => setPaletteFieldId(null)}
                              />

                              {layoutMode === "preview" ? (
                                <div className="card pad">
                                  <SectionTitle
                                    title="Preview (Form)"
                                    right={
                                      <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                                        <button
                                          className="btn-ghost"
                                          onClick={() => {
                                            if (!selectedRecordId) createRecord();
                                            else openEditRecord(selectedRecordId);
                                          }}
                                        >
                                          {selectedRecordId ? "Open Record" : "New Record"}
                                        </button>
                                        <button
                                          className="btn"
                                          onClick={() => {
                                            if (!selectedRecordId) return alert("Select or create a record first.");
                                            saveRecord();
                                          }}
                                          disabled={!selectedRecordId}
                                        >
                                          Save
                                        </button>
                                      </div>
                                    }
                                  />

                                  {!selectedRecordId || !recordDraft ? (
                                    <div className="muted" style={{ fontSize: 13 }}>
                                      Select a record in <b>Data</b> or click <b>New Record</b>.
                                    </div>
                                  ) : (
                                    <div
                                      className="card"
                                      style={{
                                        background: "#fafafa",
                                        borderRadius: 18,
                                        overflow: "hidden",
                                        width: activeLayout.canvas.width,
                                        height: activeLayout.canvas.height,
                                        position: "relative",
                                        border: "1px solid var(--border)",
                                      }}
                                    >
                                      {(activeLayout.items ?? []).map((it) => {
                                        const f = table.fields[it.fieldId];
                                        if (!f) return null;
                                        const val = recordDraft[f.id];
                                        const setVal = (next) => setRecordDraft((prev) => ({ ...prev, [f.id]: next }));

                                        return (
                                          <div
                                            key={it.id}
                                            className="layoutItem"
                                            style={{ left: it.x, top: it.y, width: it.w, height: it.h }}
                                          >
                                            <div className="layoutItemHead" style={{ paddingTop: 10 }}>
                                              <span className="name" style={{ fontWeight: 900, fontSize: 12, flex: 1 }}>
                                                {it.label || f.name}
                                              </span>
                                            </div>
                                            <div className="layoutItemBody">
                                              {f.type === "text" ? (
                                                <input className="input" style={{ padding: "8px 10px", borderRadius: 10 }} value={val ?? ""} onChange={(e) => setVal(e.target.value)} />
                                              ) : f.type === "number" ? (
                                                <input className="input" style={{ padding: "8px 10px", borderRadius: 10 }} type="number" value={val ?? ""} onChange={(e) => setVal(normalizeValue("number", e.target.value))} />
                                              ) : f.type === "date" ? (
                                                <input className="input" style={{ padding: "8px 10px", borderRadius: 10 }} type="date" value={(val ?? "").slice(0,10)} onChange={(e) => setVal(normalizeValue("date", e.target.value))} />
                                              ) : f.type === "boolean" ? (
                                                <label style={{ display: "inline-flex", alignItems: "center", gap: 10 }}>
                                                  <input type="checkbox" checked={!!val} onChange={(e) => setVal(e.target.checked)} />
                                                  <span className="muted" style={{ fontSize: 13 }}>{val ? "True" : "False"}</span>
                                                </label>
                                              ) : f.type === "select" ? (
                                                <select value={val ?? ""} onChange={(e) => setVal(e.target.value)}>
                                                  <option value="">â€”</option>
                                                  {(f.options ?? []).map((opt) => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                              ) : (
                                                <input className="input" style={{ padding: "8px 10px", borderRadius: 10 }} value={val ?? ""} onChange={(e) => setVal(e.target.value)} />
                                              )}
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  )}
                                </div>
                              ) : null}
                            </>
                          )}
                        </div>
                      </div>
                    ) : null}
                  </div>
                )}
              </div>
            </div>

            {/* New table modal */}
            <Modal
              title="New Table"
              open={isNewTableOpen}
              onClose={() => setIsNewTableOpen(false)}
              footer={
                <>
                  <button className="btn-ghost" onClick={() => setIsNewTableOpen(false)}>Cancel</button>
                  <button className="btn" onClick={createTable} disabled={!newTableName.trim()}>Create</button>
                </>
              }
            >
              <div className="col" style={{ gap: 10 }}>
                <div style={{ fontSize: 13, fontWeight: 800, color: "#3f3f46" }}>Name</div>
                <input className="input" value={newTableName} onChange={(e) => setNewTableName(e.target.value)} placeholder="e.g. Projects" />
                <div className="muted" style={{ fontSize: 12 }}>Tip: each table has its own fields, records, and layouts.</div>
              </div>
            </Modal>

            {/* Add field modal */}
            <Modal
              title="Add Field"
              open={isFieldModalOpen}
              onClose={() => setIsFieldModalOpen(false)}
              footer={
                <>
                  <button className="btn-ghost" onClick={() => setIsFieldModalOpen(false)}>Cancel</button>
                  <button className="btn" onClick={addField} disabled={!fieldDraft.name.trim()}>Add</button>
                </>
              }
            >
              <div className="col" style={{ gap: 12 }}>
                <div>
                  <div style={{ fontSize: 13, fontWeight: 800, color: "#3f3f46", marginBottom: 6 }}>Field name</div>
                  <input className="input" value={fieldDraft.name} onChange={(e) => setFieldDraft((d) => ({ ...d, name: e.target.value }))} />
                </div>

                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, alignItems: "end" }}>
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 800, color: "#3f3f46", marginBottom: 6 }}>Type</div>
                    <select value={fieldDraft.type} onChange={(e) => setFieldDraft((d) => ({ ...d, type: e.target.value }))}>
                      {FIELD_TYPES.map((t) => <option key={t.id} value={t.id}>{t.label}</option>)}
                    </select>
                  </div>
                  <label style={{ display: "inline-flex", alignItems: "center", gap: 10, padding: "8px 2px" }}>
                    <input type="checkbox" checked={fieldDraft.required} onChange={(e) => setFieldDraft((d) => ({ ...d, required: e.target.checked }))} />
                    <span style={{ fontSize: 13, fontWeight: 800, color: "#3f3f46" }}>Required</span>
                  </label>
                </div>

                {fieldDraft.type === "select" ? (
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 800, color: "#3f3f46", marginBottom: 6 }}>Options (one per line)</div>
                    <textarea value={fieldDraft.optionsText} onChange={(e) => setFieldDraft((d) => ({ ...d, optionsText: e.target.value }))} placeholder={"Option A\nOption B\nOption C"} />
                  </div>
                ) : null}
              </div>
            </Modal>

            {/* Import modal */}
            <Modal
              title="Import JSON"
              open={isImportOpen}
              onClose={() => setIsImportOpen(false)}
              footer={<button className="btn-ghost" onClick={() => setIsImportOpen(false)}>Close</button>}
            >
              <div className="col" style={{ gap: 10 }}>
                <div style={{ fontSize: 13, color: "#3f3f46" }}>Choose an export file previously created by this widget.</div>
                <input
                  type="file"
                  accept="application/json"
                  onChange={(e) => {
                    const f = e.target.files?.[0];
                    if (f) handleImport(f);
                  }}
                />
                {importErr ? <div style={{ color: "var(--danger)", fontWeight: 800 }}>Error: {importErr}</div> : null}
                <div className="muted" style={{ fontSize: 12 }}>Import replaces your current data. Export first if you want a backup.</div>
              </div>
            </Modal>

            {/* Floating helper */}
            {activeTab === "layouts" && layoutMode === "edit" && paletteFieldId ? (
              <div className="helpFloat">
                <div style={{ fontWeight: 900 }}>Placing field</div>
                <div className="muted" style={{ fontSize: 13, marginTop: 6 }}>Click on the canvas to place the selected field.</div>
                <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
                  <button className="btn-ghost" onClick={() => setPaletteFieldId(null)}>Cancel</button>
                  <button className="btn" onClick={() => { /* no-op */ }}>Keep Selected</button>
                </div>
              </div>
            ) : null}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<FileMakerLikeWidget />);
    </script>
  </body>
</html>
